<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="/static/Main/css/app.css">
    <style>
        .stage{
            margin: 50px auto 0;
            width: 1000px;
        }
        .stage .add{
            color: #ff6600;
            cursor: pointer;
        }
        #canvas {
            display: block;
            border: 1px solid #ccc;
        }
        .exhibitionForm{
            display: none;
        }
        .inputBox{
            overflow: hidden;
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            color: #333;
        }
        .inputBox span{
            display: block;
            width: 50px;
            text-align: right;
            color: #333;
        }
        .input,.select{
            margin-left: 5px;
            padding-left: 10px;
            flex:1;
            height: 30px;
            line-height: 30px;
            outline: none;
            color: #333;
        }
        .select{
            height: 34px;
            line-height: 34px;
        }
        .select option{
            color: #333;
        }
    </style>
</head>

<body>
    <div class="exhibitionForm">
        <div class="inputBox"><span>长(米):</span><input class="input width" type="text" placeholder="请输入长度"></div>
        <div class="inputBox"><span>宽(米):</span><input class="input height" type="text" placeholder="请输入宽度"></div>
        <div class="inputBox">
            <span>状态:</span>
            <select class="select" name="status">
                <option value="">请选择</option>
                <option value="0">未售</option>
                <option value="1">已售</option>
            </select>
        </div>
        <div class="inputBox"><span>展商:</span><input class="input height" type="text" placeholder="请输入展商"></div>
        <div class="inputBox">
            <span>非我司:</span>
            <select class="select" name="status">
                <option value="">请选择</option>
                <option value="0">否</option>
                <option value="1">是</option>
            </select>
        </div>
        <div class="inputBox"><span>备注:</span><input class="input height" type="text" placeholder="请输入备注"></div>
    </div>

    <div class="stage">
        <div class="action"></div>
        <p>双击修改展会大小</p>
        <span class="add">添加</span>
        <canvas id="canvas" width="1000" height="500"></canvas>
    </div>

    <script src="/static/Main/js/lib/jquery1.12.4.min.js"></script>
    <script src="/static/Main/js/lib/layer/layer.js"></script>

    <script>
        var scale = 10;
        $(function() {
            var cvs = document.getElementById('canvas');
            var ctx = cvs.getContext('2d');

            var bgConfig = {
                x:20,
                y:20,
                width:96*scale,
                height:46*scale
            }

            // 绘制背景
            function drawBg() {
                ctx.fillStyle = '#ececec';
                ctx.beginPath();
                ctx.rect(bgConfig.x, bgConfig.y, bgConfig.width, bgConfig.height);
                ctx.closePath();
                ctx.fill();
            }

            // 绘制展台
            function drawExhibition(config) {
                this.config = $.extend({},{
                    width:5*scale,
                    height:5*scale,
                    x:20,
                    y:20,
                    color:'#ccc',
                    // textColor:'#fff'
                },config);

                return {
                    config:this.config,
                    drawText:function () {
                        ctx.strokeStyle = this.config.textColor;
                        ctx.font="8px 微软雅黑";
                        ctx.strokeText('自定义展台',this.config.x+this.config.width*scale/2-20,this.config.height*scale/2+this.config.y+3);
                    },
                    setTextColor:function (textColor) {
                        this.config.textColor = textColor;
                    },
                    draw:function () {
                        ctx.fillStyle = this.config.color;
                        ctx.beginPath();
                        ctx.rect(this.config.x, this.config.y, this.config.width*scale, this.config.height*scale);
                        ctx.closePath();
                        ctx.fill();

                        this.drawText();
                    },
                    reDraw:function (width,height) {
                        this.config.width = width;
                        this.config.height = height;
                        this.draw();
                    },
                    setExhibitionColor:function (color) {
                        this.config.color = color;
                        this.draw();
                    },
                    move:function (x,y) {
                        this.config.x = x;
                        this.config.y = y;
                        this.draw();
                    }
                }
            }

            // 标尺
            function drawRule() {
                // ctx.strokeStyle = '#ececec';
                // ctx.translate(0.5,0.5);
                // ctx.beginPath();
                // ctx.moveTo(20,10);
                // ctx.lineTo(980,10);
                // ctx.stroke();
                // ctx.closePath();
                // 长度
                ctx.beginPath();
                ctx.strokeStyle = '#000';
                ctx.font="12px 微软雅黑";
                ctx.strokeText('长'+bgConfig.width/10+'米',(bgConfig.x+bgConfig.width)/2,bgConfig.y/1.4);
                ctx.closePath();
                ctx.fill();
                // 宽度
                ctx.beginPath();
                ctx.strokeStyle = '#000';
                ctx.font="12px 微软雅黑";
                ctx.strokeText('宽',bgConfig.x/5,(bgConfig.y+bgConfig.height)/2-12);
                ctx.strokeText(bgConfig.height/10,bgConfig.x/5,(bgConfig.y+bgConfig.height)/2);
                ctx.strokeText('米',bgConfig.x/5,(bgConfig.y+bgConfig.height)/2+12);
                ctx.closePath();
                ctx.fill();
            }

            // 初始化场景
            var exhibition,mode = 'default';
            function init() {
                drawBg();
                drawRule();

                exhibition = new drawExhibition({width:5,height:5});
                exhibition.draw();
            }
            init();

            function getMousePoint(e) {
                // 得到鼠标的坐标
                var eventX = e.clientX - canvas.getBoundingClientRect().left;
                var eventY = e.clientY - canvas.getBoundingClientRect().top;
                return {
                    x: eventX,
                    y: eventY,
                    clientX: e.clientX,
                    clientY: e.clientY
                };
            }

            // 选中展台
            cvs.onmousemove = function(e) {
                var mousePoint = getMousePoint(e);
                ctx.clearRect(0, 0, 1000, 500);

                drawBg();
                drawRule();
                exhibition.draw();

                if (ctx.isPointInPath(mousePoint.x, mousePoint.y)) {
                    exhibition.setExhibitionColor('#4c91d6');
                    exhibition.setTextColor('#fff');
                    if(mode == 'default'){
                        cvs.style.cursor = 'pointer';
                    }
                } else {
                    exhibition.setExhibitionColor('#ccc');
                    exhibition.setTextColor('#333');
                    if(mode == 'default'){
                        cvs.style.cursor = 'default';
                    }
                }

                // 移动展台
                if(mode == 'move'){
                    var insW = exhibition.config.width*scale;
                    var insH = exhibition.config.height*scale;
                    // 居中 移动
                    exhibition.move(mousePoint.x-insW/2,mousePoint.y-insH/2);
                    // console.log(mousePoint);
                    // console.log(exhibition.config);
                }
            }

            // 修改展台宽高
            cvs.ondblclick = function(e) {
                var mousePoint = getMousePoint(e);
                if (ctx.isPointInPath(mousePoint.x, mousePoint.y)) {
                    var width = exhibition.config.width;
                    var height = exhibition.config.height;
                    layer.open({
                        type: 1,
                        skin:'layui-layer-dialog',
                        area: ['300px'],
                        btn:['确定'],
                        content: $('.exhibitionForm'),
                        yes:function (index,layero) {
                            layer.close(index);
                            width = parseInt($(layero).find('.inputBox .width').val());
                            height = parseInt($(layero).find('.inputBox .height').val());

                            drawBg();
                            drawRule();
                            exhibition.reDraw(width,height);
                        }
                    });
                }
            }

            // 设置展台鼠标十字
            cvs.onmousedown = function(e) {
                var mousePoint = getMousePoint(e);
                cvs.style.cursor = 'move';
                mode = 'move';
            }
            cvs.onmouseup = function(e) {
                cvs.style.cursor = 'default';
                mode = 'default';
            }
        });
    </script>
</body>

</html>
