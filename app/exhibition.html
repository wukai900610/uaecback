<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="/static/Main/css/app.css">
</head>

<body>
    <div class="exhibitionForm">
        <div class="inputBox"><span>长(米):</span><input class="input width" type="text" placeholder="请输入长度"></div>
        <div class="inputBox"><span>宽(米):</span><input class="input height" type="text" placeholder="请输入宽度"></div>
        <div class="inputBox">
            <span>状态:</span>
            <select class="select status">
                <option value="0">未售</option>
                <option value="1">已售</option>
            </select>
        </div>
        <div class="inputBox"><span>展商:</span><input class="input exhibition" type="text" placeholder="请输入展商"></div>
        <div class="inputBox">
            <span>非我司:</span>
            <select class="select isOurcompany">
                <option value="0">否</option>
                <option value="1">是</option>
            </select>
        </div>
        <div class="inputBox"><span>备注:</span><input class="input remarks" type="text" placeholder="请输入备注"></div>
    </div>

    <div style="margin:20px auto 0;">
        <p>双击修改展会大小</p>
        <span class="add">添加</span>
        <div id="exhibitionStage" class="exhibitionStage"></div>
    </div>

    <script src="/static/Main/js/lib/jquery1.12.4.min.js"></script>
    <script src="/static/Main/js/lib/layer/layer.js"></script>

    <script>
        $(function() {
            function Exhibition(stageConfig) {
                this.stageConfig = stageConfig;
                this.scale = 10;
                this.insIndex = 0;
                this.mode = 'default';
                this.exhibitionConfig = [];

                // 创建展馆
                this.creditStage();

                var that = this;
                // 修改展台
                var exhibitionIndex,currentConfig={},delIndex;
                $(document).on('dblclick',that.stageConfig.target + ' .exhibition',function () {
                    var width = currentConfig.width;
                    var height = currentConfig.height;
                    var status = currentConfig.status;
                    var exhibition = currentConfig.exhibition;
                    var isOurcompany = currentConfig.isOurcompany;
                    var remarks = currentConfig.remarks;

                    layer.open({
                        type: 1,
                        skin:'layui-layer-dialog',
                        area: ['300px'],
                        btn:['确定'],
                        content: $('.exhibitionForm'),
                        success:function (layero,index) {
                            $(layero).find('.width').val(width);
                            $(layero).find('.height').val(height);
                            $(layero).find('.status').val(status);
                            $(layero).find('.exhibition').val(exhibition);
                            $(layero).find('.isOurcompany').val(isOurcompany);
                            $(layero).find('.remarks').val(remarks);
                        },
                        yes:function (index,layero) {
                            layer.close(index);
                            var config = {
                                width:parseInt($(layero).find('.width').val()),
                                height:parseInt($(layero).find('.height').val()),
                                status:$(layero).find('.status').val(),
                                exhibition:$(layero).find('.exhibition').val(),
                                isOurcompany:$(layero).find('.isOurcompany').val(),
                                remarks:$(layero).find('.remarks').val()
                            }

                            that.reDrawExhibition(exhibitionIndex,config);
                        }
                    });
                });

                // 获取删除的索引
                $(document).on('mouseover',that.stageConfig.target + ' .exhibition',function () {
                    delIndex = $(this).data('index');
                });
                $(document).on('mouseout',that.stageConfig.target + ' .exhibition',function () {
                    delIndex = null;
                });
                // 移动
                $(document).on('mousedown',that.stageConfig.target + ' .exhibition',function () {
                    exhibitionIndex = $(this).data('index');
                    currentConfig = that.exhibitionConfig[exhibitionIndex];
                    that.mode = 'move';
                    $(that.stageConfig.target).css('cursor','move');
                    $(that.stageConfig.target + ' .exhibition').css({
                        'z-index':0
                    });
                    $(that.stageConfig.target + ' .exhibition[data-index='+exhibitionIndex+']').css({
                        'z-index':1
                    });
                });
                $(document).on('mouseup',that.stageConfig.target + ' .exhibition',function () {
                    that.mode = 'default';
                });
                // 删除
                $(document).on('mouseup',that.stageConfig.target + ' .exhibition .delete',function () {
                    that.delExhition(delIndex);
                });
                // 移动展台
                var pOfl = $(that.stageConfig.target).offset().left;
                var pOft = $(that.stageConfig.target).offset().top;
                $(document).on('mousemove',that.stageConfig.target,function (e) {
                    var left = e.pageX-pOfl;
                    var top = e.pageY-pOft;

                    if(that.mode == 'move'){
                        $(that.stageConfig.target + ' .exhibition[data-index='+exhibitionIndex+']').css({
                            'left':left-currentConfig.width*that.scale/2,
                            'top':top-currentConfig.height*that.scale/2,
                        });
                    }
                });

                this.add = function (insConfig) {
                    var config = {
                        insIndex:this.insIndex,
                        width:5*this.scale,
                        height:5*this.scale,
                        x:20,
                        y:20,
                        status:0,
                        exhibition:'',
                        isOurcompany:0,
                        remarks:''
                    }
                    var _this = this;
                    config = $.extend({},config,insConfig);
                    this.exhibitionConfig.push(config);

                    this.insIndex++;

                    var draw = function () {
                        var html = '<div class="exhibition" data-index="'+config.insIndex+'" style="width:'+config.width*_this.scale+'px;height:'+config.height*_this.scale+'px;left:'+config.x+'px;top:'+config.y+'px"><span class="delete"></span><div></div></div>';
                        $(_this.stageConfig.target).find('.stage').append(html);
                    }
                    draw();

                    return config;
                }
            }
            Exhibition.prototype.creditStage = function () {
                var html = '<div class="ruleWrap">'+this.creditRule()+'</div><div class="stage"></div>';
                $(this.stageConfig.target).append(html);
                $(this.stageConfig.target).css({width:this.stageConfig.width,height:this.stageConfig.height});
            }
            Exhibition.prototype.creditRule = function () {
                var width = '<span class="width">长:'+(this.stageConfig.width/this.scale)+'米</span>';
                var height = '<span class="height">宽:'+(this.stageConfig.height/this.scale)+'米</span>';
                return width+height;
            }
            Exhibition.prototype.reDrawExhibition = function (index,config) {
                var _this = this;
                _this.exhibitionConfig.map(function (item) {
                    if(item.insIndex == index){
                        for(var i in config){
                            item[i] = config[i];
                        }
                    }
                });
                $(_this.stageConfig.target).find('.exhibition[data-index='+index+']').css({
                    width:config.width*_this.scale,
                    height:config.height*_this.scale,
                });
                $(_this.stageConfig.target).find('.exhibition[data-index='+index+'] div').css({
                    background:config.status == 0 ? '#39983d' : '#f00'
                });
            }
            Exhibition.prototype.delExhition = function (index) {
                var _this = this;
                _this.exhibitionConfig.map(function (item) {
                    if(item.insIndex == index){
                        _this.exhibitionConfig.splice(index,1,{});
                        $(_this.stageConfig.target).find('.exhibition[data-index='+index+']').detach();
                    }
                });
            }

            var exhibitionStage = new Exhibition({target:'#exhibitionStage',width:1000,height:400});
            exhibitionStage.add({width:8,height:5});
            exhibitionStage.add({width:15,height:12,x:100,y:150});

            $('.add').click(function () {
                var width = parseInt(Math.random()*10)+5;
                var height = parseInt(Math.random()*10)+5;
                var x = parseInt(Math.random()*800);
                var y = parseInt(Math.random()*300);

                exhibitionStage.add({width:width,height:height,x:x,y:y});
            });
        });
    </script>
</body>

</html>
